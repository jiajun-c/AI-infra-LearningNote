# cuda同步机制

cuda的同步机制可以将其分为三类

- 最传统的显式同步机制，让所有线程进行等待阻塞
- Async-group：将访存请求分为不同阶段的commit，以流水线的形式进行管理
- mbarrier：共享协同机制，基于信号灯模型

## 1. 最早的显式同步机制

早期的同步机制基于`__syncthreads()`，该同步指令我们可以将其拆解为两个部分：
- 线程同步：保证所有的线程到达同样的位置
- 数据同步：保证所有线程的访存请求被执行，不会读取到旧值

根据知乎博主的文章，将其拆分为更细的三个部分，首先是内存可见性，保证所有线程的读写请求被执行，然后是线程流同步，保证所有线程都到达同样的位置，最后是内存可见性，保证所有线程的读写请求被执行，更新当前线程的缓存行，保证不会读取到旧值。

```cpp
void __syncthreads() {
  // --- Part A: 内存可见性（生产者视角） ---
  memory_release(); 
  
  // --- Part B: 执行流同步（硬件计数器） ---
  thread_arrive();
  wait_all_threads();
  
  // --- Part C: 内存可见性（消费者视角） ---
  memory_acquire();
}
```

## 2. Async-group

该同步机制基于提交等待的机制，使用commit我们可以提交一组异步指令，组间的异步指令是有顺序的，但是组内的指令没顺序，通过wait指令我们可以等待n个commit指令的组