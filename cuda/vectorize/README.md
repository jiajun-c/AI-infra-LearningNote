# CUDA 向量化

cuda中可以利用 `type[count]` 类型来一次性加载多个元素同时对多个元素进行访存运算等操作，相比于直接逐元素访存运算会块很多

如下所示进行一个简单的封装

```cpp
#define INT4(value) (reinterpret_cast<int4*>(&(value))[0])
#define FLOAT4(value) (reinterpret_cast<float4*>(&(value))[0])
#define HALF2(value) (reinterpret_cast<half2*>(&(value))[0])
#define BFLOAT2(value) (reinterpret_cast<__nv_bfloat162*>(&(value))[0])
#define LDST128BITS(value) (reinterpret_cast<float4*>(&(value))[0])
```

baseline
```cpp
__global__ void elementwise_add_f32_kernel(float* a, float* b, float* c, int N) {
  int idx = blockIdx.x * blockDim.x + threadIdx.x;
  if (idx < N) c[idx] = a[idx] + b[idx];
}
```

进行向量化，使用FLOAT4每次加载四个float元素。

```cpp
__global__ void elementwise_add_f32x4_kernel(float* a, float* b, float* c, int N) {
  int idx = 4 * (blockIdx.x * blockDim.x + threadIdx.x);
  if (idx < N) {
    float4 reg_a = FLOAT4(a[idx]);
    float4 reg_b = FLOAT4(b[idx]);
    float4 reg_c;
    reg_c.x = reg_a.x + reg_b.x;
    reg_c.y = reg_a.y + reg_b.y;
    reg_c.z = reg_a.z + reg_b.z;
    reg_c.w = reg_a.w + reg_b.w;
    FLOAT4(c[idx]) = reg_c;
  }
}
```

对half类型进行操作，这里做向量化有两种方式
- 全部使用half2的方式进行访存和计算，每次加载两个half
- 使用float4(128b)的方式进行访存，然后使用half2从对应位置加载数据进行运算

方法一

```cpp
__global__ void elementwise_add_f16x8_kernel(half* a, half* b, half* c, int N) {
  int idx = 8 * (blockIdx.x * blockDim.x + threadIdx.x);
  half2 reg_a_0 = HALF2(a[idx + 0]);
  half2 reg_a_1 = HALF2(a[idx + 2]);
  half2 reg_a_2 = HALF2(a[idx + 4]);
  half2 reg_a_3 = HALF2(a[idx + 6]);
  half2 reg_b_0 = HALF2(b[idx + 0]);
  half2 reg_b_1 = HALF2(b[idx + 2]);
  half2 reg_b_2 = HALF2(b[idx + 4]);
  half2 reg_b_3 = HALF2(b[idx + 6]);
  half2 reg_c_0, reg_c_1, reg_c_2, reg_c_3;
  reg_c_0.x = __hadd(reg_a_0.x, reg_b_0.x);
  reg_c_0.y = __hadd(reg_a_0.y, reg_b_0.y);
  reg_c_1.x = __hadd(reg_a_1.x, reg_b_1.x);
  reg_c_1.y = __hadd(reg_a_1.y, reg_b_1.y);
  reg_c_2.x = __hadd(reg_a_2.x, reg_b_2.x);
  reg_c_2.y = __hadd(reg_a_2.y, reg_b_2.y);
  reg_c_3.x = __hadd(reg_a_3.x, reg_b_3.x);
  reg_c_3.y = __hadd(reg_a_3.y, reg_b_3.y);
  if ((idx + 0) < N) { HALF2(c[idx + 0]) = reg_c_0; }
  if ((idx + 2) < N) { HALF2(c[idx + 2]) = reg_c_1; }
  if ((idx + 4) < N) { HALF2(c[idx + 4]) = reg_c_2; }
  if ((idx + 6) < N) { HALF2(c[idx + 6]) = reg_c_3; }
}
```


方法2

```cpp
__global__ void elementwise_add_f16x8_pack_kernel(half* a, half* b, half* c, int N) {
  int idx = 8 * (blockIdx.x * blockDim.x + threadIdx.x);
  // temporary register(memory), .local space in ptx, addressable
  half pack_a[8], pack_b[8], pack_c[8]; // 8x16 bits=128 bits.
  // reinterpret as float4 and load 128 bits in 1 memory issue.
  LDST128BITS(pack_a[0]) = LDST128BITS(a[idx]); // load 128 bits
  LDST128BITS(pack_b[0]) = LDST128BITS(b[idx]); // load 128 bits

  #pragma unroll
  for (int i = 0; i < 8; i += 2) {
    // __hadd2 for half2 x 4
    HALF2(pack_c[i]) = __hadd2(HALF2(pack_a[i]), HALF2(pack_b[i]));
  }
  // reinterpret as float4 and store 128 bits in 1 memory issue.
  if ((idx + 7) < N) { LDST128BITS(c[idx]) = LDST128BITS(pack_c[0]); }
}
```


benchmark 结果

```shell
-------------------------------------------------------------------------------------
                                        S=1024, K=1024
           out_f32: [1.41806173, -0.53331554], time:0.04576778ms
         out_f32x4: [1.41806173, -0.53331554], time:0.03260088ms
        out_f32_th: [1.41806173, -0.53331554], time:0.03748202ms
-------------------------------------------------------------------------------------
           out_f16: [1.41796875, -0.53320312], time:0.03701353ms
         out_f16x2: [1.41796875, -0.53320312], time:0.02780485ms
         out_f16x8: [1.41796875, -0.53320312], time:0.03542662ms
     out_f16x8pack: [1.41796875, -0.53320312], time:0.02689409ms
        out_f16_th: [1.41796875, -0.53320312], time:0.02723002ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=2048
           out_f32: [1.21888542, 1.10273683], time:0.07392645ms
         out_f32x4: [1.21888542, 1.10273683], time:0.05668783ms
        out_f32_th: [1.21888542, 1.10273683], time:0.05655622ms
-------------------------------------------------------------------------------------
           out_f16: [1.21875, 1.10253906], time:0.05698657ms
         out_f16x2: [1.21875, 1.10253906], time:0.04603457ms
         out_f16x8: [1.21875, 1.10253906], time:0.06334567ms
     out_f16x8pack: [1.21875, 1.10253906], time:0.03585005ms
        out_f16_th: [1.21875, 1.10253906], time:0.03641486ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=4096
           out_f32: [0.36108172, -1.66528118], time:0.23677683ms
         out_f32x4: [0.36108172, -1.66528118], time:0.21432495ms
        out_f32_th: [0.36108172, -1.66528118], time:0.23983383ms
-------------------------------------------------------------------------------------
           out_f16: [0.36108398, -1.66503906], time:0.11496520ms
         out_f16x2: [0.36108398, -1.66503906], time:0.10406160ms
         out_f16x8: [0.36108398, -1.66503906], time:0.16461921ms
     out_f16x8pack: [0.36108398, -1.66503906], time:0.04627323ms
        out_f16_th: [0.36108398, -1.66503906], time:0.06541800ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=1024
           out_f32: [0.78550565, -0.09878927], time:0.08647346ms
         out_f32x4: [0.78550565, -0.09878927], time:0.06059670ms
        out_f32_th: [0.78550565, -0.09878927], time:0.05510402ms
-------------------------------------------------------------------------------------
           out_f16: [0.78515625, -0.09863281], time:0.04200506ms
         out_f16x2: [0.78515625, -0.09863281], time:0.03567624ms
         out_f16x8: [0.78515625, -0.09863281], time:0.06481409ms
     out_f16x8pack: [0.78515625, -0.09863281], time:0.03601241ms
        out_f16_th: [0.78515625, -0.09863281], time:0.04503465ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=2048
           out_f32: [1.56880069, -0.61075509], time:0.25789833ms
         out_f32x4: [1.56880069, -0.61075509], time:0.23788071ms
        out_f32_th: [1.56880069, -0.61075509], time:0.23634267ms
-------------------------------------------------------------------------------------
           out_f16: [1.56933594, -0.61083984], time:0.11587834ms
         out_f16x2: [1.56933594, -0.61083984], time:0.07237601ms
         out_f16x8: [1.56933594, -0.61083984], time:0.11481667ms
     out_f16x8pack: [1.56933594, -0.61083984], time:0.05942845ms
        out_f16_th: [1.56933594, -0.61083984], time:0.06492853ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=4096
           out_f32: [-0.50300789, -0.00345138], time:0.45791960ms
         out_f32x4: [-0.50300789, -0.00345138], time:0.43755698ms
        out_f32_th: [-0.50300789, -0.00345138], time:0.43857980ms
-------------------------------------------------------------------------------------
           out_f16: [-0.50292969, -0.00341797], time:0.24440479ms
         out_f16x2: [-0.50292969, -0.00341797], time:0.23276043ms
         out_f16x8: [-0.50292969, -0.00341797], time:0.31085348ms
     out_f16x8pack: [-0.50292969, -0.00341797], time:0.22084713ms
        out_f16_th: [-0.50292969, -0.00341797], time:0.21454716ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=1024
           out_f32: [-0.60771489, 0.00613886], time:0.24220634ms
         out_f32x4: [-0.60771489, 0.00613886], time:0.23605013ms
        out_f32_th: [-0.60771489, 0.00613886], time:0.22977567ms
-------------------------------------------------------------------------------------
           out_f16: [-0.60839844, 0.00585938], time:0.13269830ms
         out_f16x2: [-0.60839844, 0.00585938], time:0.07578540ms
         out_f16x8: [-0.60839844, 0.00585938], time:0.09321213ms
     out_f16x8pack: [-0.60839844, 0.00585938], time:0.04189181ms
        out_f16_th: [-0.60839844, 0.00585938], time:0.06325006ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=2048
           out_f32: [0.05354017, 0.2044314], time:0.44152236ms
         out_f32x4: [0.05354017, 0.2044314], time:0.40928555ms
        out_f32_th: [0.05354017, 0.2044314], time:0.44925046ms
-------------------------------------------------------------------------------------
           out_f16: [0.05371094, 0.2043457], time:0.33722901ms
         out_f16x2: [0.05371094, 0.2043457], time:0.18618894ms
         out_f16x8: [0.05371094, 0.2043457], time:0.24268055ms
     out_f16x8pack: [0.05371094, 0.2043457], time:0.22432518ms
        out_f16_th: [0.05371094, 0.2043457], time:0.23880672ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=4096
           out_f32: [1.38044024, 1.5579797], time:0.85746670ms
         out_f32x4: [1.38044024, 1.5579797], time:0.89003134ms
        out_f32_th: [1.38044024, 1.5579797], time:0.65545893ms
-------------------------------------------------------------------------------------
           out_f16: [1.38085938, 1.55761719], time:0.53535414ms
         out_f16x2: [1.38085938, 1.55761719], time:0.32608294ms
         out_f16x8: [1.38085938, 1.55761719], time:0.65118527ms
     out_f16x8pack: [1.38085938, 1.55761719], time:0.44852924ms
        out_f16_th: [1.38085938, 1.55761719], time:0.47788382ms
-------------------------------------------------------------------------------------
```